- name: install zsh
  pacman: name=zsh state=present

- name: create prezto folder
  file: path=/home/{{ user.name }}/.zprezto state=directory owner={{ user.name }} recurse=true

- name: install prezto
  git: repo=https://github.com/sorin-ionescu/prezto.git dest=/home/{{ user.name }}/.zprezto force=yes

- name: get rid of existing ~/.zshrc
  file: path=/home/{{ user.name }}/.zshrc state=absent owner={{ user.name }}

- name: symlink new dotfiles
  file: src=/home/{{ user.name }}/.zprezto/runcoms/{{ item }} dest=/home/{{ user.name }}/.{{ item }}
        state=link owner={{ user.name }}
  with_items:
    - zlogin
    - zlogout
    - zprofile
    - zshenv
    - zshrc

- name: switch to Zsh
  user: name={{ user.name }} shell=/usr/bin/zsh

- name: install fasd
  pacman: name=fasd state=present

- name: get rid of existing ~/.zpreztorc
  file: path=/home/{{ user.name }}/.zpreztorc state=absent owner={{ user.name }}

- name: copy my zprezto
  template: src=zpreztorc dest=/home/{{ user.name }}/.zpreztorc owner={{ user.name }}

- name: test kubectl alias
  shell: grep 'alias k=kubectl' /home/{{ user.name }}/.zshrc
  register: test_alias
  ignore_errors: true

- name: add kubectl completion and alias
  lineinfile:
    path: /home/{{ user.name }}/.zshrc
    line: | 
      source <(kubectl completion zsh)
      alias ku=kubectl
  when: test_alias is failed

- name: test default editor
  shell: grep 'EDITOR' /home/{{ user.name }}/.zshrc
  register: test_editor
  ignore_errors: true

- name: add default editor
  lineinfile:
    path: /home/{{ user.name }}/.zshrc
    line: | 
      export EDITOR=vim
      export KUBE_EDITOR=vim
      export VISUAL=vim
  when: test_editor is failed

- name: create a new ssh key
  user:
    name: '{{ user.name }}'
    generate_ssh_key: yes
    ssh_key_bits: 2048
    ssh_key_file: .ssh/id_rsa
  become: yes
  become_user: '{{ user.name }}'
